---
import AutoscrollSwitch from "../AutoscrollSwitch";
import ShowTagsSwitch from "../ShowTagsSwitch";
import TagFilter from "../TagFilter";
import TextSearch from "../TextSearch";
import { getEntry } from "astro:content";
import type { CollectionEntry } from "astro:content";

interface Props {
  annotationSet: CollectionEntry<'annotations'>,
  playerId: string,
  type: 'Audio' | 'Video'
}

const projectData = await getEntry('project', 'project');

const { annotationSet, playerId, type } = Astro.props;

const tagGroups = projectData.data.project.tags.tagGroups;

let allTags: { [key: string]: { tags: string[]; color: string } } = {};
if (annotationSet.data.annotations.length > 0) {
  annotationSet.data.annotations.forEach((ann) => {
    if (ann.tags && ann.tags.length) {
      ann.tags.forEach((tag: { category: string; tag: string }) => {
        const cat = tag.category.toLowerCase();
        allTags[cat] ||= {
          tags: [],
          color:
            tagGroups.find((grp) => grp.category.toLowerCase() === cat)?.color ||
            '#FFF',
        };
        if (!allTags[cat].tags.includes(tag.tag)) {
          allTags[cat].tags.push(tag.tag);
          allTags[cat].tags.sort();
        }
      });
    }
  });
}

---
<div>
  <div
    class={`flex flex-row w-full justify-between items-center ${type === 'Video' ? 'flex-col gap-3' : 'flex-row items-center'}`}
  >
    <div class={`flex flex-row justify-between ${type === 'Video' ? 'w-full' : ''}`}>
      <h3 class='font-bold text-lg'>Annotations</h3>
      {
        type === 'Video' && (
          <div>
            <div class="flex flex-row align-center gap-4">
              <AutoscrollSwitch playerId={playerId} client:only='react' />
              <ShowTagsSwitch playerId={playerId} client:only='react' />
            </div>
          </div>)
      }
    </div>
    { type === 'Video' && <div class="h-1 border-t border-gray-200 w-full" />}
    <div class={`flex flex-row gap-8 items-center ${type === 'Video' ? 'w-full justify-between pb-4 z-10 shadow-[0px_4px_2px_-2px_#00000040]' : ''}`}>
    {
      type === 'Audio' && (
        <AutoscrollSwitch playerId={playerId} client:only='react' />
        <ShowTagsSwitch playerId={playerId} client:only='react' />
      )
    }
      <TextSearch playerId={playerId} client:only='react' />
      <TagFilter playerId={playerId} tags={allTags} client:only='react' />
    </div>
  </div>
</div>
