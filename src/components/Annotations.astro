---
import RichText from '@components/RichText/index.astro';
import { formatTimestamp } from '../utils/player';
import { PlayCircleIcon } from '@heroicons/react/24/outline';
import projectData from '@data/project.json';
import TagPill from './tags/TagPill.astro';

export interface Props {
  playerId: string;
  annotations: any[];
}

const { playerId, annotations } = Astro.props;

const tagGroups: { category: string; color: string }[] =
  projectData.project.tags.tagGroups;
---

<div
  class='border border-collapse border-black relative overflow-y-scroll max-h-[80dvh]'
  id={playerId}
>
  {
    annotations.map((ann: any) => {
      return (
        <div
          class='annotationNode flex flex-row justify-between gap-4 p-4 border-t border-b border-t-black border-b-black'
          data-start={ann.start_time}
          data-end={ann.end_time}
        >
          <div class='flex flex-row gap-2 w-[10%] items-start'>
            <button
              class='playAnnotation'
              data-start={ann.start_time}
              data-end={ann.end_time}
              data-player-id={playerId}
            >
              <PlayCircleIcon className='h-6 w-6' />
            </button>
            <p class='w-[10%] font-semibold text-sm'>{`${formatTimestamp(ann.start_time, false)}-${formatTimestamp(ann.end_time, false)}`}</p>
          </div>
          <div class='w-[90%] flex flex-col gap-4'>
            <RichText nodes={ann.annotation} />
            <div class='flex flex-row gap-4'>
              {ann.tags?.map((tag: any) => {
                const group = tagGroups.find(
                  (group) =>
                    group.category.toLowerCase() == tag.category.toLowerCase()
                );
                return (
                  <TagPill tag={tag.tag} color={group ? group.color : '#FFF'} />
                );
              })}
            </div>
          </div>
        </div>
      );
    })
  }
</div>

<script>
  import { $pagePlayersState } from 'src/store.ts';
  const annotationPlayNodes = document.getElementsByClassName('playAnnotation');
  const annotationNodes = document.getElementsByClassName('annotationNode');
  for (let i = 0; i < annotationPlayNodes.length; i++) {
    const thisNode = annotationPlayNodes[i];
    if (
      thisNode instanceof HTMLElement &&
      thisNode.dataset.start &&
      thisNode.dataset.playerId
    ) {
      const annotationStartsNew =
        $pagePlayersState.get()[thisNode.dataset.playerId].annotationStarts;
      if (annotationStartsNew) {
        annotationStartsNew.push({
          start: Math.floor(Number(thisNode.dataset.start)),
          end: Math.floor(Number(thisNode.dataset.end)),
        });
        $pagePlayersState.setKey(thisNode.dataset.playerId, {
          ...$pagePlayersState.get()[thisNode.dataset.playerId],
          annotationStarts: annotationStartsNew,
        });
      }
      thisNode.addEventListener('click', () => {
        const playerId = thisNode.dataset.playerId || 'null';
        $pagePlayersState.setKey(playerId, {
          ...$pagePlayersState.get()[playerId],
          position: Number(thisNode.dataset.start),
          seekTo: Number(thisNode.dataset.start),
          isPlaying: true,
        });
      });
    }
  }

  $pagePlayersState.listen((state, oldState, changed) => {
    if (
      changed &&
      Math.floor(state[changed].position * 1000) % 7 == 0 && //this is just meant to get it firing at a reasonable interval
      state[changed].autoScroll
    ) {
      const startTimes = state[changed].annotationStarts;
      const current = startTimes?.findIndex(
        (time) =>
          time.start <= state[changed].position &&
          time.end > state[changed].position
      );
      if (typeof current == 'number' && current >= 0) {
        const activeNode = annotationNodes[current];
        activeNode.scrollIntoView({ block: 'center', behavior: 'smooth' });
        activeNode.classList.add('bg-red-50');
        for (let i = 0; i < annotationNodes.length; i++) {
          if (i != current) {
            annotationNodes[i].classList.remove('bg-red-50');
          }
        }
      }
    }
  });
</script>
